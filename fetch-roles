#!/bin/bash
set -eux
TMPDIR='/tmp/dci-tmp-dir'
BASEDIR=$(pwd)


get_repo() {
    repo=${1}
    roles=${2}
    cd ${TMPDIR}
    git clone https://code.engineering.redhat.com/gerrit/${repo}.git ${repo}
    cd ${repo}
    for topic in OSP8 OSP9 OSP10 OSP11 OSP12; do
        branch=$(echo ${topic}|sed 's,OSP,origin/stable/rhos-,')
        target=${BASEDIR}/roles/${topic}
        mkdir -p ${target}
        git checkout -b ${topic} ${branch}
	# See: https://review.openstack.org/#/c/507889/
	[ ${repo} = 'tripleo-quickstart-extras' ] &&  find -name '*.yml' -exec sed -i "s/lookup('env', 'PWD')/local_working_dir/" "{}" \;
        for i in ${roles}; do
           cp -av roles/${i} ${target}/${i}
        done
	git reset --hard
	git clean -ffdx
    done
}

rm -Rf ${TMPDIR} ${BASEDIR}/roles
mkdir -p ${TMPDIR}
get_repo tripleo-quickstart "common tripleo-inventory"
get_repo tripleo-quickstart-extras "collect-logs extras-common validate-tempest"
